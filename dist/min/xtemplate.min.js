/**
 * 在指定对象平级附加一个对象
 * @param newEl
 * @param targetEl
 */
function insertAfter(newEl, targetEl) {
    var parentEl = targetEl.parentNode;
    if (!parentEl) {
        return;
    }
    if (parentEl.lastChild == targetEl) {
        parentEl.appendChild(newEl);
    } else {
        parentEl.insertBefore(newEl, targetEl.nextSibling);
    }
}
/**
 * 取下一个节点
 * @param ele
 * @returns {*}
 */
function getNextSibling(ele) {
    if (ele.nextElementSibling && ele.nextElementSibling.tagName == ele.tagName) {
        return ele.nextElementSibling;
    } else {
        return false;
    }
}
/**
 * 给指定对象设置值
 * @param ele
 * @param value
 */
function setValue(ele, value) {
    switch (ele.tagName) {
        case 'INPUT':
            ele.value = value;
            break;
        default:
            ele.innerText = value;
            break;
    }

}

/**
 * 取扁平的字典值
 * @param key
 * @param data
 * @returns {*}
 */
function getNameValue(key, data) {
    var value = data[key];
    var type = typeof value;
    if (type == 'string' || type == 'number') {
        return [[key, value]];
    } else {
        var names = [];
        for (var k in value) {
            var tkv = getNameValue(k, value);
            for (var i = 0; i < tkv.length; i++) {
                names.push([key + '.' + tkv[i][0], tkv[i][1]]);
            }
        }
        return names;
    }
}
/**
 * 取数组的key全集
 * @param key
 * @param data
 * @returns {*}
 */
function getName(key, data) {
    var value = data[key];
    var type = typeof value;
    if (type == 'string' || type == 'number') {
        return [key];
    } else {
        var names = [];
        for (var k in value) {
            var tkv = getName(k, value);
            for (var i = 0; i < tkv.length; i++) {
                names.push(key + '.' + tkv[i]);
            }
        }
        return names;
    }
}
/**
 * 是否有指定串开头
 * @param str
 * @param startString
 */
function startWith(str, startString) {
    if (str && startString && str.length > startString.length && str.substr(0, startString.length) == startString) {
        return true;
    } else {
        return false;
    }
}
/**
 * 是否为数字
 * @param chars
 * @returns {boolean}
 */
function isNumber(chars) {
    var re = /^(-?\d+)(\.\d+)?/;
    return chars.match(re) != null;
}

/**
 * 取指定数组的值
 * @param key
 * @param data
 * @returns {*}
 */
function getValue(key, data) {
    var keys = key.split('.'), result = data[keys.shift()];
    for (var i = 0; result && i < keys.length; i++) {
        result = result[keys[i]];
    }
    if (result) {
        return result;
    } else {
        return '';
    }
}

/**
 * 默认值
 * @param val
 * @param defaultVal
 * @returns {*}
 */
function defaultValue(val, defaultVal) {
    if (!val && defaultVal) {
        return defaultVal;
    }
    return val;
}
/**
 * 按值选择返回内容
 * @param val
 * @returns {*}
 */
function selectCase(val) {
    for (var i = 1; i < arguments.length; i += 2) {
        if (val == arguments[i] && i < arguments.length - 1) {
            return arguments[i + 1];
        }
    }
    return arguments[arguments.length - 1];
}
/**
 * 格式化货币
 * @param val
 * @returns {Number}
 */
function formatCurrency(val) {
    return parseFloat(val);
}


/**
 * 将 Date 转化为指定格式的String
 * 月(M)、日(d)、小时(h)、分(m)、秒(s)、季度(q) 可以用 1-2 个占位符，
 * 年(y)可以用 1-4 个占位符，毫秒(S)只能用 1 个占位符(是 1-3 位的数字)
 * 例子：
 * (new Date()).Format("yyyy-MM-dd hh:mm:ss.S") ==> 2006-07-02 08:09:04.423
 * (new Date()).Format("yyyy-M-d h:m:s.S")      ==> 2006-7-2 8:9:4.18
 * @param val
 * @param fmt
 */
function formatData(val, fmt) {
    if (typeof(val) == 'number') {
        val = new Date(val);
    }
    var format_data_o = {
        "M+": val.getMonth() + 1,                 //月份
        "d+": val.getDate(),                    //日
        "h+": val.getHours(),                   //小时
        "m+": val.getMinutes(),                 //分
        "s+": val.getSeconds(),                 //秒
        "q+": Math.floor((val.getMonth() + 3) / 3), //季度
        "S": val.getMilliseconds()             //毫秒
    };
    if (/(y+)/.test(fmt))
        fmt = fmt.replace(RegExp.$1, (val.getFullYear() + "").substr(4 - RegExp.$1.length));
    for (var k in format_data_o)
        if (new RegExp("(" + k + ")").test(fmt))
            fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (format_data_o[k]) : (("00" + format_data_o[k]).substr(("" + format_data_o[k]).length)));
    return fmt;

}
/**
 * 数字保留小数位数
 * @param num
 * @param c
 * @returns {string}
 */
function toFixed(num, c) {
    return num.toFixed(c);
}
/**
 * 初始化自定义函数
 * @param cache
 */
function initFuncs(cache) {
    cache['default'] = defaultValue;
    cache['case'] = selectCase;
    cache['format_currency'] = formatCurrency;
    cache['format_date'] = formatData;
}

/**
 * 初始化语法结构
 * @param id 渲染器的有效范围id
 */
function initSynctax(items, cache) {
    for (var i = 0; i < items.length; i++) {
        var item = items[i];
        if (!initBind(item, cache)) {
            initRepeat(item, cache);
        }
    }
}
/**
 * 处理绑定函数
 * @param item
 * @param cache
 */
function initBind(item, cache) {
    var id = item.attributes['data-bind-func'];
    if (id) {
        var name = item.attributes['name'].value;
        var funcBody = '(function ($scope,func,vo){return ' + runTemplate('{' + name + '|' + id.value + '}') + ';})';
        try {
            cache['xdf-bind-' + name] = eval(funcBody);
            return true;
        } catch (e) {
            console.log('解析bind模板' + id.value + '出错，' + e.message);
        }
    }
    return false;
}
/**
 * 处理循环
 * @param item
 * @param cache
 */
function initRepeat(item, cache) {
    var id = item.attributes['data-repeat-name'];
    if (id) {
        item.style.display = 'none';
        cache['xd-repeat-' + id.value] = item;
        var funcBody = '(function ($scope,func,vo){return ' + runTemplate(item.innerHTML) + ';})';
        try {
            cache['xdf-repeat-' + id.value] = eval(funcBody);
        } catch (e) {
            cache['xdf-repeat-' + id.value] = function () {
            };
            console.log('解析repeat模板' + id.value + '出错，' + e.message);
        }
    }
}


/**
 * 将数据与模块绑定
 * @param tmpl
 * @param data
 * @returns {XML|string|void}
 */
function runTemplate(tmpl) {
    var i = 0, start = 0, end = 0, word, result = [];
    while (i < tmpl.length) {
        start = tmpl.indexOf('{', i);
        if (start != -1) {
            end = tmpl.indexOf('}', start + 1);
            if (end == -1) {
                end = tmpl.length;
            }
            word = tmpl.substring(start + 1, end);
            result.push(runText(tmpl.substring(i, start)));
            result.push(runFunc(word));
        } else {
            result.push(runText(tmpl.substring(i)));
            end = tmpl.length;
        }
        i = end + 1;
    }
    return result.join('+');
}
/**
 * 处理字符串
 * @param text
 */
function runText(text) {
    if (text) {
        return '"' + text.replace(/\"/g, '\\"').replace(/\r/g, '\\r').replace(/\n/g, '\\n') + '"';
    } else {
        return '""'
    }
}
/**
 * 处理函数
 * @param funcString
 * @param val
 * @returns {*}
 */
function runFunc(funcString) {
    var f = funcString.split('|');
    if (f.length > 0) {
        return runFuncString(f, f.length - 1);
    }
    return '""';
}
/**
 * 组合出函数结构
 * @param funcs
 * @param i
 * @returns {*}
 */
function runFuncString(funcs, i) {
    if (i > 0) {
        var funcArray = funcs[i].split(',');
        if (funcArray.length > 0) {
            var funcName = funcArray[0];
            funcArray[0] = runFuncString(funcs, i - 1);
            return 'func.' + funcName + '(' + funcArray.join(',') + ')';
        }
    } else {
        return runWord(funcs[0]);
    }
    return '';
}
/**
 * 处理关键字
 * 有几类数据
 * 1、数字，可以以-.开头
 * 2、$scope.全局变量
 * 3、循环变量
 * 4、以"或'包围的字符串
 * @param word
 */
function runWord(word) {
    if (word.length > 0) {
        if (word[0] == '$' || isNumber(word) || word[0] == '"' || word[0] == "'") {
            return word;
        } else {
            return "getValue('" + word + "',vo)";
        }
    }
    return '""'
}

/**
 * 渲染器
 */
function Render() {
    //全局变量
    this.$scope = {};
    //可绑定的key列表
    this.$bindKey = {};
    //缓存
    this.cache = {};
    //内部函数
    this.funcs = {};
    //初始化语法结构
    initSynctax(document.all, this.cache);
    //初始化自带的函数
    initFuncs(this.funcs);
}

/**
 * 绑定数据值
 * @param id 缓存范围的id
 * @param data 要绑定的数据
 */
Render.prototype.bindData = function (data, name) {
    if (!name) {
        name = 'data';
    }
    this.$scope[name] = data;
    this.$bindKey[name] = [];
    for (var key in data) {
        var k = getName(key, data);
        for (var i = 0; i < k.length; i++) {
            this.$bindKey[name].push(k[i]);
        }
    }

    for (var j = 0; j < this.$bindKey[name].length; j++) {
        var key = this.$bindKey[name][j], item = this.$scope[name];
        if (name != 'data') {
            key = name + '.' + key;
            item = this.$scope;
        }

        var items = document.getElementsByName(key);
        for (var i = 0; i < items.length; i++) {
            var xf = this.cache['xdf-bind-' + key];
            if (xf) {
                setValue(items[i], xf(this.$scope, this.funcs, item));
            } else {
                setValue(items[i], getValue(key, item));
            }
            items[i].style.display = '';
        }
    }
}
/**
 * 重新给某个对象绑定新的值
 * @param name
 * @param value
 */
Render.prototype.bindName = function (name, value) {
    var items = document.getElementsByName(name);
    if (items) {
        //this.$scope[name] = value;
        for (var i = 0; i < items.length; i++) {
            setValue(items[i], value);
            items[i].style.display = '';
        }
    }
}
/**
 * 循环绑定数据值
 * @param id 缓存范围的id
 * @param data 要绑定的数据
 */
Render.prototype.bindRepeatData = function (data, id) {
    var item = this.cache['xd-repeat-' + id];
    if (!item) {
        return;
    }
    if (!data || data.length < 1) {
        return;
    }
    var nextItem = item;
    for (var i = 0; i < data.length; i++) {
        var tmp = getNextSibling(nextItem);
        if (!tmp) {
            tmp = document.createElement(item.tagName);
            insertAfter(tmp, nextItem);
        }
        var func = this.cache['xdf-repeat-' + id];
        if (func) {
            tmp.innerHTML = func(this.$scope, this.funcs, data[i]);
        }

        tmp.style.display = '';
        nextItem = tmp;
    }
    while ((nextItem = getNextSibling(nextItem)) != false) {
        nextItem.style.display = 'none';
    }
}


/**
 * 增加自定义函数
 * @param func
 * @param name
 */
Render.prototype.addFunc = function (func, name) {
    this.funcs[name] = func;
}

//@codekit-prepend "./utils.js"
//@codekit-prepend "./funcs.js"
//@codekit-prepend "./syntax.js"
//@codekit-prepend "./render.js"

